{"ast":null,"code":"import _toConsumableArray from\"/home/bzeeno/Code/Go/RealTimeChat/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _regeneratorRuntime from\"/home/bzeeno/Code/Go/RealTimeChat/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/bzeeno/Code/Go/RealTimeChat/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/home/bzeeno/Code/Go/RealTimeChat/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect,useRef}from'react';import useStateWithCallback from'use-state-with-callback';//import {Button} from '../components/Button'\nimport{useHistory}from'react-router-dom';import{Preview}from'../components/Preview';//import Alert from '@material-ui/lab/Alert'\nimport{Search}from'../components/Search';import{CreateRoom}from'../components/CreateRoom';import'./Home.scss';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export var Home=function Home(props){/*\n    const socket = new WebSocket(\"ws://localhost:8000/ws/\")\n    const socketRef = useRef();\n    socketRef.current = socket;\n    */var socket=useRef(null);var _useState=useState(false),_useState2=_slicedToArray(_useState,2),search=_useState2[0],setSearch=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),createRoom=_useState4[0],setCreateRoom=_useState4[1];var _useState5=useState(''),_useState6=_slicedToArray(_useState5,2),friends=_useState6[0],setFriends=_useState6[1];var _useState7=useState([]),_useState8=_slicedToArray(_useState7,2),rooms=_useState8[0],setRooms=_useState8[1];var _useState9=useState(''),_useState10=_slicedToArray(_useState9,2),requests=_useState10[0],setRequests=_useState10[1];// friend requests\nvar requestsRef=useRef();requestsRef.current=requests;var _useStateWithCallback=useStateWithCallback(null,function(req){if(req!==null&&socket.current.readyState===1){socket.current.send(JSON.stringify(req));_setReq(null);}}),_useStateWithCallback2=_slicedToArray(_useStateWithCallback,2),req=_useStateWithCallback2[0],_setReq=_useStateWithCallback2[1];var history=useHistory();props.setRoomID(null);if(!localStorage.getItem(\"user\")){history.push('/login');}var showSearchWindow=function showSearchWindow(){return setSearch(!search);};// toggle search bar\nvar showRoomWindow=function showRoomWindow(){return setCreateRoom(!createRoom);};// toggle search bar\nvar searchClass=search?'rotate-icon':'';var roomClass=createRoom?'rotate-icon':'';console.log(\"requests in home: \",requests);useEffect(function(){var isMounted=true;var getFriends=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var response,result;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return fetch(\"http://\".concat(process.env.REACT_APP_SERVER_URL,\"/api/get-friends\"),{headers:{'Content-Type':'application/json'},credentials:'include'});case 2:response=_context.sent;_context.next=5;return response.json();case 5:result=_context.sent;if(isMounted){setFriends(result['friends']);}case 7:case\"end\":return _context.stop();}}},_callee);}));return function getFriends(){return _ref.apply(this,arguments);};}();var getFriendReqs=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var response,result;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return fetch(\"http://\".concat(process.env.REACT_APP_SERVER_URL,\"/api/get-friend-reqs\"),{headers:{'Content-Type':'application/json'},credentials:'include'});case 2:response=_context2.sent;_context2.next=5;return response.json();case 5:result=_context2.sent;if(isMounted){setRequests(result['requests']);}case 7:case\"end\":return _context2.stop();}}},_callee2);}));return function getFriendReqs(){return _ref2.apply(this,arguments);};}();var getRooms=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var response,result;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return fetch(\"http://\".concat(process.env.REACT_APP_SERVER_URL,\"/api/get-rooms\"),{headers:{'Content-Type':'application/json'},credentials:'include'});case 2:response=_context3.sent;_context3.next=5;return response.json();case 5:result=_context3.sent;if(isMounted){setRooms(result['rooms']);}case 7:case\"end\":return _context3.stop();}}},_callee3);}));return function getRooms(){return _ref3.apply(this,arguments);};}();if(isMounted){getFriends().catch(setFriends(''));getFriendReqs().catch(setRequests(''));getRooms().catch(setRooms([]));}socket.current=new WebSocket(\"ws://\".concat(process.env.REACT_APP_SERVER_URL,\"/ws\"));socket.current.onopen=function(event){console.log(\"Connected to ws\");//socket.current.send(JSON.stringify({friend_id: 0+'', req: \"HELP ME\"}))\n};socket.current.onmessage=function(request){var new_req=JSON.parse(request.data);console.log(\"requests: \",requests);switch(new_req['req']){case'add-friend':console.log(\"requests: \",requestsRef.current);var filteredRequests=[];var isInRequests=false;// check if friend is in requests\nObject.keys(requestsRef.current).map(function(key){if(requestsRef.current[key]!==new_req['friend_id']){// if friend is not current request:\nfilteredRequests.push(requests[key]);// add to array\n}else{isInRequests=true;// otherwise: set isInRequests to true\n}return requestsRef.current[key];});console.log(\"isInRequests: \",isInRequests);if(new_req['sender_id']===props.user['_id']){// if this client is the sender:\nif(isInRequests){// if accepting friend request:\nconsole.log(\"Accepting friend request\");console.log(\"new requests: \",filteredRequests);setRequests(filteredRequests);// setRequests to array without friend that was just added\nsetFriends(function(prev){return[].concat(_toConsumableArray(prev),[new_req['friend_id']]);});// setFriends with newly added friend\n}}else{// if this client is the receiver:\nif(new_req['in_pending']==='true'){// if other client accepted friend request:\nconsole.log(\"Friend accepted request\");setFriends(function(prev){return[].concat(_toConsumableArray(prev),[new_req['friend_id']]);});// setFriends with newly added friend\n}else{// if received friend request from other client:\nconsole.log(\"Received friend request\");setRequests(function(prev){return[].concat(_toConsumableArray(prev),[new_req['friend_id']]);});// setRequests with client who sent request\n}}break;case'remove-friend':var filteredArray=[];Object.keys(friends).map(function(key){console.log(\"friend: \",friends[key]);if(friends[key]!==new_req['friend_id']){filteredArray.push(friends[key]);}return friends[key];});console.log(\"filtered array: \",filteredArray);setFriends(filteredArray);break;case'add-to-room':console.log(\"In add-to-room\");console.log(\"Is receiver: \",new_req['sender_id']!==props.user['_id']);if(new_req['sender_id']!==props.user['_id']){// if this client is not the sender:\nwindow.location.reload();//setRooms(prev => [...prev, new_req['room_id']])    // setRequests with client who sent request (this doesn't work, very annoying)\n}break;default:_setReq(null);break;}};socket.current.onclose=function(event){console.log(\"socket closed connection: \",event);};return function(){isMounted=false;};},[]);//const sendReq = () =>{ console.log(\"req in sendReq: \", req); socket.current.send(req); }\n//console.log(\"req in home: \", req)\nreturn/*#__PURE__*/_jsxs(\"div\",{className:\"container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"rooms-header\",children:[/*#__PURE__*/_jsx(\"h2\",{className:\"rooms-header-text mb-0\",children:\"Friends\"}),/*#__PURE__*/_jsx(\"i\",{className:\"fas fa-plus-circle add-btn mb-0 \".concat(searchClass),onClick:showSearchWindow})]}),/*#__PURE__*/_jsx(\"div\",{className:\"search-window-container\",children:/*#__PURE__*/_jsx(Search,{search:search,setSearch:setSearch,setReq:function setReq(data){_setReq(data);},user:props.user})}),/*#__PURE__*/_jsx(\"div\",{className:\"row\",children:friends===null?null:Object.keys(friends).map(function(key){return/*#__PURE__*/_jsx(\"div\",{className:\"col-sm-12 col-md-4 col-lg-2 px-0 mx-3\",children:/*#__PURE__*/_jsx(Preview,{alt:\"friend\",size:\"img-large\",isRoom:false,friend_id:friends[key],setReq:function setReq(data){_setReq(data);},user:props.user,inPending:false,overlay:true})},key);})}),/*#__PURE__*/_jsxs(\"div\",{className:\"rooms-header\",children:[/*#__PURE__*/_jsx(\"h2\",{className:\"rooms-header-text mt-2\",children:\"Rooms\"}),/*#__PURE__*/_jsx(\"i\",{className:\"fas fa-plus-circle add-btn mb-0 \".concat(roomClass),onClick:showRoomWindow})]}),/*#__PURE__*/_jsx(\"div\",{className:\"search-window-container\",children:/*#__PURE__*/_jsx(CreateRoom,{createRoom:createRoom})}),/*#__PURE__*/_jsx(\"div\",{className:\"row\",children:rooms===null?null:Object.keys(rooms).map(function(key){return/*#__PURE__*/_jsx(\"div\",{className:\"col-sm-12 col-md-4 col-lg-2 px-0 mx-3\",children:/*#__PURE__*/_jsx(Preview,{alt:\"default_room.jpeg\",size:\"img-large\",isRoom:true,room_id:rooms[key],setReq:function setReq(data){_setReq(data);},user:props.user,overlay:true})},key);})}),/*#__PURE__*/_jsx(\"div\",{className:\"rooms-header\",children:/*#__PURE__*/_jsx(\"h2\",{className:\"rooms-header-text mb-0\",children:\"Pending Friends\"})}),/*#__PURE__*/_jsx(\"div\",{className:\"row\",children:requests===null?null:Object.keys(requests).map(function(key){return/*#__PURE__*/_jsx(\"div\",{className:\"col-sm-12 col-md-4 col-lg-2 px-0 mx-3\",children:/*#__PURE__*/_jsx(Preview,{src:\"default_pic.jpeg\",alt:\"friend\",size:\"img-large\",name:\"username\",isRoom:false,friend_id:requests[key],setReq:function setReq(data){_setReq(data);},user:props.user,inPending:true,overlay:true})},key);})}),/*#__PURE__*/_jsx(\"p\",{className:\"mt-5 mb-3 mx-auto text-muted\",children:\"\\xA9 2017\\u20132021\"})]});};","map":{"version":3,"sources":["/home/bzeeno/Code/Go/RealTimeChat/frontend/src/pages/Home.js"],"names":["React","useState","useEffect","useRef","useStateWithCallback","useHistory","Preview","Search","CreateRoom","Home","props","socket","search","setSearch","createRoom","setCreateRoom","friends","setFriends","rooms","setRooms","requests","setRequests","requestsRef","current","req","readyState","send","JSON","stringify","setReq","history","setRoomID","localStorage","getItem","push","showSearchWindow","showRoomWindow","searchClass","roomClass","console","log","isMounted","getFriends","fetch","process","env","REACT_APP_SERVER_URL","headers","credentials","response","json","result","getFriendReqs","getRooms","catch","WebSocket","onopen","event","onmessage","request","new_req","parse","data","filteredRequests","isInRequests","Object","keys","map","key","user","prev","filteredArray","window","location","reload","onclose"],"mappings":"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","sourcesContent":["import React, {useState, useEffect, useRef} from 'react'\nimport useStateWithCallback from 'use-state-with-callback';\n//import {Button} from '../components/Button'\nimport {useHistory} from 'react-router-dom'\nimport {Preview} from '../components/Preview'\n//import Alert from '@material-ui/lab/Alert'\nimport {Search} from '../components/Search'\nimport {CreateRoom} from '../components/CreateRoom'\nimport './Home.scss'\n\nexport const Home = (props) => {\n    /*\n    const socket = new WebSocket(\"ws://localhost:8000/ws/\")\n    const socketRef = useRef();\n    socketRef.current = socket;\n    */\n    const socket = useRef(null);\n\n    const [search, setSearch] = useState(false)\n    const [createRoom, setCreateRoom] = useState(false)\n    const [friends, setFriends] = useState('')\n    const [rooms, setRooms] = useState([])\n    const [requests, setRequests] = useState('') // friend requests\n    const requestsRef = useRef();\n    requestsRef.current = requests;\n    const [req, setReq] = useStateWithCallback(null, req => {\n        if (req !== null && socket.current.readyState === 1) {\n            socket.current.send(JSON.stringify(req));\n            setReq(null);\n        } \n    });\n    const history = useHistory()\n    props.setRoomID(null)\n\n    if(!localStorage.getItem(\"user\")) {\n        history.push('/login')\n    }\n\n    const  showSearchWindow = () => setSearch(!search) // toggle search bar\n    const  showRoomWindow = () => setCreateRoom(!createRoom) // toggle search bar\n    const searchClass = search ? 'rotate-icon' : '';\n    const roomClass = createRoom ? 'rotate-icon' : '';\n\n    console.log(\"requests in home: \", requests)\n\n    useEffect(() => {\n        let isMounted = true;\n        const getFriends = async() => {\n            const response = await fetch(`http://${process.env.REACT_APP_SERVER_URL}/api/get-friends`, {\n                headers: {'Content-Type': 'application/json'},\n                credentials: 'include'\n            })\n\n            const result = await response.json()\n            if (isMounted) {\n                setFriends(result['friends']) \n            }\n        }\n        const getFriendReqs = async() => {\n            const response = await fetch(`http://${process.env.REACT_APP_SERVER_URL}/api/get-friend-reqs`, {\n                headers: {'Content-Type': 'application/json'},\n                credentials: 'include'\n            })\n            const result = await response.json()\n            if (isMounted) {\n                setRequests(result['requests'])\n            }\n        }\n        const getRooms = async() => {\n            const response = await fetch(`http://${process.env.REACT_APP_SERVER_URL}/api/get-rooms`, {\n                headers: {'Content-Type': 'application/json'},\n                credentials: 'include'\n            })\n\n            const result = await response.json()\n            if (isMounted) {\n                setRooms(result['rooms']) \n            }\n        }\n\n        if (isMounted) {\n            getFriends().catch(setFriends(''))\n            getFriendReqs().catch(setRequests(''))\n            getRooms().catch(setRooms([]))\n        }\n\n        socket.current = new WebSocket(`ws://${process.env.REACT_APP_SERVER_URL}/ws`)\n        socket.current.onopen = (event) => {\n            console.log(\"Connected to ws\")\n            //socket.current.send(JSON.stringify({friend_id: 0+'', req: \"HELP ME\"}))\n        }\n        socket.current.onmessage = (request) => {\n            let new_req = JSON.parse(request.data)\n            console.log(\"requests: \", requests)\n            switch(new_req['req']) {\n                case 'add-friend':\n                    console.log(\"requests: \", requestsRef.current)\n                    let filteredRequests = [];\n                    let isInRequests = false;\n                    // check if friend is in requests\n                    Object.keys(requestsRef.current).map(key => {\n                        if (requestsRef.current[key] !== new_req['friend_id']) { // if friend is not current request:\n                            filteredRequests.push(requests[key])   // add to array\n                        } else {\n                            isInRequests = true;                  // otherwise: set isInRequests to true\n                        }\n                        return requestsRef.current[key]\n                    })\n                    console.log(\"isInRequests: \", isInRequests)\n                    if (new_req['sender_id'] === props.user['_id']) {           // if this client is the sender:\n                        if(isInRequests) {                                          // if accepting friend request:\n                            console.log(\"Accepting friend request\")\n                            console.log(\"new requests: \", filteredRequests)\n                            setRequests(filteredRequests)                               // setRequests to array without friend that was just added\n                            setFriends(prev => [...prev, new_req['friend_id']])         // setFriends with newly added friend\n                        }                                                       \n                    } else {                                                    // if this client is the receiver:\n                        if(new_req['in_pending'] === 'true') {                      // if other client accepted friend request:\n                            console.log(\"Friend accepted request\")\n                            setFriends(prev => [...prev, new_req['friend_id']])         // setFriends with newly added friend\n                        } else {                                                // if received friend request from other client:\n                            console.log(\"Received friend request\")\n                            setRequests(prev => [...prev, new_req['friend_id']])    // setRequests with client who sent request\n                        }\n                    }\n                    break;\n                case 'remove-friend':\n                    let filteredArray = [];\n                    Object.keys(friends).map(key => {\n                        console.log(\"friend: \", friends[key])\n                        if (friends[key] !== new_req['friend_id']) {\n                           filteredArray.push(friends[key])\n                        }\n                        return friends[key]\n                    })\n                    console.log(\"filtered array: \", filteredArray)\n                    setFriends(filteredArray)\n                    break;\n                case 'add-to-room':\n                    console.log(\"In add-to-room\")\n                    console.log(\"Is receiver: \", new_req['sender_id'] !== props.user['_id'])\n                    if (new_req['sender_id'] !== props.user['_id']) {    // if this client is not the sender:\n                        window.location.reload();\n                        //setRooms(prev => [...prev, new_req['room_id']])    // setRequests with client who sent request (this doesn't work, very annoying)\n                    }\n                    break;\n                default:\n                    setReq(null)\n                    break;\n            }\n        }\n\n        socket.current.onclose = (event) => {\n            console.log(\"socket closed connection: \", event)\n        }\n\n        return () => { isMounted=false }\n    }, [])\n\n    //const sendReq = () =>{ console.log(\"req in sendReq: \", req); socket.current.send(req); }\n\n    //console.log(\"req in home: \", req)\n\n    return(\n        <div className='container'>\n            <div className=\"rooms-header\">\n                <h2 className=\"rooms-header-text mb-0\">Friends</h2>\n                <i className={`fas fa-plus-circle add-btn mb-0 ${searchClass}`} onClick={showSearchWindow} />\n            </div>\n            <div className=\"search-window-container\">\n                <Search search={search} setSearch={setSearch} setReq={ data => {setReq(data);} } user={props.user} />\n            </div>\n            <div className='row'>\n                {friends === null ? null : Object.keys(friends).map(key => \n                    <div key={key} className='col-sm-12 col-md-4 col-lg-2 px-0 mx-3'>\n                        <Preview alt='friend' size='img-large' isRoom={false} friend_id={friends[key]} setReq={ data => {setReq(data);} } user={props.user} inPending={false} overlay={true} />\n                    </div>\n                )}\n\n            </div>\n\n\n            <div className='rooms-header'>\n                <h2 className=\"rooms-header-text mt-2\">Rooms</h2>\n                <i className={`fas fa-plus-circle add-btn mb-0 ${roomClass}`} onClick={showRoomWindow} />\n            </div>\n            <div className=\"search-window-container\">\n                <CreateRoom createRoom={createRoom} />\n            </div>\n            <div className='row'>\n                {rooms === null ? null : Object.keys(rooms).map(key => \n                    <div key={key} className='col-sm-12 col-md-4 col-lg-2 px-0 mx-3'>\n                        <Preview alt='default_room.jpeg' size='img-large' isRoom={true} room_id={rooms[key]} setReq={ data => {setReq(data);} } user={props.user} overlay={true} />\n                    </div>\n                )}\n            </div>\n\n\n            <div className=\"rooms-header\">\n                <h2 className=\"rooms-header-text mb-0\">Pending Friends</h2>\n            </div>\n            <div className='row'>\n                {requests === null ? null : Object.keys(requests).map(key =>\n                    <div className='col-sm-12 col-md-4 col-lg-2 px-0 mx-3' key={key}>\n                        <Preview src='default_pic.jpeg' alt='friend' size='img-large' name='username' isRoom={false} friend_id={requests[key]} setReq={ data => {setReq(data);} } user={props.user} inPending={true} overlay={true} />\n                    </div>\n                )}\n            </div>\n\n            <p className=\"mt-5 mb-3 mx-auto text-muted\">&copy; 2017â€“2021</p>\n\n        </div>\n    )\n}\n"]},"metadata":{},"sourceType":"module"}